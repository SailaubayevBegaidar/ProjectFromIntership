<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Tasks</title>
</head>
<body>
<h1>Task List</h1>

<!-- Ссылка для администратора -->
<div sec:authorize="hasRole('ADMIN')">
    <a th:href="@{/api/users}">Manage Users</a>
    <hr>
</div>

<table border="1">
    <thead>
    <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Started On</th>
        <th>Completed On</th>
        <th>Location</th>
        <th>Assigned To</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="task : ${tasks}">
        <td th:text="${task.id}"></td>
        <td th:text="${task.title}"></td>
        <td>
            <span th:if="${task.startedOn != null}" th:text="${#temporals.format(task.startedOn, 'yyyy-MM-dd HH:mm')}"></span>
            <span th:unless="${task.startedOn != null}">—</span>
        </td>
        <td>
            <span th:if="${task.completedOn != null}" th:text="${#temporals.format(task.completedOn, 'yyyy-MM-dd HH:mm')}"></span>
            <span th:unless="${task.completedOn != null}">—</span>
        </td>
        <td th:text="${task.location}"></td>
        <td>
            <span th:if="${task.assignedTo != null}" th:text="${task.assignedTo}"></span>
            <span th:unless="${task.assignedTo != null}">Not assigned</span>
        </td>
        <td>
            <a th:href="@{'/api/tasks/' + ${task.id}}">View</a> |
            <div sec:authorize="hasAnyRole('ADMIN', 'MASTER')">
                <a th:href="@{/api/tasks/edit/{id}(id=${task.id})}" class="btn btn-sm btn-warning">Edit</a>
                <form th:action="@{/api/tasks/delete/{id}(id=${task.id})}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </form>
            </div>
            <div sec:authorize="hasRole('ENGINEER')">
                <form th:action="@{/api/tasks/assign/{id}(id=${task.id})}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-sm btn-info">Assign to Me</button>
                </form>
            </div>
        </td>
    </tr>
    </tbody>
</table>

<a th:href="@{/api/tasks/create}">+ Create New Task</a>

<!-- Отображение информации о текущем пользователе -->
<div style="margin-top: 20px;">
    <p>
        Logged in as: <span sec:authentication="name"></span> |
        Roles: <span sec:authentication="principal.authorities"></span> |
        <a th:href="@{/login}">Logout</a>
    </p>
</div>
</body>
</html>